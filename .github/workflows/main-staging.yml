name: Workflow for Staging Environment

on:
  pull_request:
    branches: ["main"]

jobs:
  build:
    permissions:
      checks: write
      packages: write
    uses: ./.github/workflows/gradle.yml
    with:
      environment: staging
    secrets: inherit

  provision:
    permissions:
      contents: write      # required to merge PRs
      actions: write       # required for plan persistence
      id-token: write      # required for workload-identity-federation
      pull-requests: write # required to post PR comments
      issues: read         # required to check if PR number is an issue or not
      statuses: write      # required to validate combined PR status
    uses: ./.github/workflows/terraform.yml
    with:
      environment: staging
    secrets: inherit

  deploy:
    uses: ./.github/workflows/ansible.yml
    needs: [build, provision]
    with:
      environment: staging
    secrets: inherit

