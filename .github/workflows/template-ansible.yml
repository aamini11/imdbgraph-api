name: "Template: Ansible"

on:
  workflow_call:
    inputs:
      environment:
        type: string
        required: true

jobs:
  ansible:
    environment: ${{ inputs.environment }}
    runs-on: ubuntu-22.04
    env:
      SSH_PRIVATE_KEY: ${{secrets.SSH_PRIVATE_KEY}}
      SSH_KNOWN_HOSTS: ${{secrets.SSH_KNOWN_HOSTS}}

      DATABASE_HOST: ${{vars.DATABASE_HOST}}
      DATABASE_NAME: ${{vars.DATABASE_NAME}}
      DATABASE_USER: ${{vars.DATABASE_USER}}
      DATABASE_PASSWORD: ${{vars.DATABASE_PASSWORD}}

      OMDB_KEY: ${{vars.OMDB_KEY}}

      CI_REGISTRY: ghcr.io
      CI_REGISTRY_USER: ${{ github.actor }}
      CI_REGISTRY_PASSWORD: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout Sources
        uses: actions/checkout@v4
      - name: Setup SSH
        shell: bash
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 400 ~/.ssh/id_rsa 
          
          echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
      - name: Run ansible script
        run: |
          cd infra/ansible
          ansible-playbook -i ${{inputs.environment}} site.yml